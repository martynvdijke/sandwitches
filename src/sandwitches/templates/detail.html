{% extends "base_beer.html" %}
{% block title %}{{ recipe.title }} â€” Sandwitch{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
    @media only screen and (min-width: 992px) {
        main.container {
            padding-left: 10%;
            padding-right: 10%;
        }
    }
</style>
{% load custom_filters %} {# Load your custom filters #} 
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Recipe",
  "name": "{{ recipe.title }}",
  {% if recipe.image %}
  "image": "{{ request.scheme }}://{{ request.get_host }}{{ recipe.image_medium.url }}",
  {% endif %}
  "author": {
    "@type": "Person",
    "name": "{% if recipe.uploaded_by %}{{ recipe.uploaded_by.get_full_name|default:recipe.uploaded_by.username }}{% else %}Anonymous{% endif %}"
  },
  "datePublished": "{{ recipe.created_at|date:"Y-m-d" }}",
  "description": "{{ recipe.description|striptags|truncatechars:200 }}",
  {% if recipe.tags.all %}
  "recipeCategory": [{% for tag in recipe.tags.all %}"{{ tag.name }}"{% if not forloop.last %},{% endif %}{% endfor %}],
  {% endif %}
  "recipeIngredient": {{ recipe.ingredients|linebreaksbr|striptags|split:"\n"|json_script:"recipe-ingredients" }},
  "recipeInstructions": {
    "@type": "ItemList",
    "itemListElement": [
      {% for instruction in recipe.instructions|linebreaksbr|striptags|split:"\n" %}
      {
        "@type": "HowToStep",
        "text": "{{ instruction }}" {# Removed |strip #}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  },
  {% if avg_rating > 0 %}
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ avg_rating|floatformat:1 }}",
    "reviewCount": "{{ rating_count }}"
  }
  {% endif %}
}
</script>
{% endblock %}

{% block content %}

{% load i18n markdown_extras %} {# Keep existing load tags #} 

<div class="space"></div>

<nav>
  <a href="{% url 'index' %}" class="button transparent circle">
      <i>arrow_back</i>
  </a>
  <h5 class="max ml-2">{% trans "Back to all" %}</h5>
</nav>

<div class="large-space"></div>

<div class="grid">
  <!-- Left Column: Image and Main Info -->
  <div class="s12 m12 l5">
     <article class="round no-padding elevate">
        {% if recipe.image %}
        <img src="{{ recipe.image_large.url }}" 
             srcset="{{ recipe.image_medium.url }} 700w, {{ recipe.image_large.url }} 1200w" 
             sizes="(max-width: 768px) 95vw, 600px"
             alt="{{ recipe.title }}" 
             loading="lazy"
             class="responsive top-round">
        {% else %}
        <div class="primary medium-height top-round middle-align center-align" style="height:300px;">
           <i class="extra">lunch_dining</i>
        </div>
        {% endif %}        
        <div class="padding">
            <div class="row align-center">
                <h4 class="bold max">{{ recipe.title }}</h4>
                {% if user.is_authenticated %}
                <a href="{% url 'toggle_favorite' recipe.pk %}" class="button circle transparent" title="{% trans 'Toggle Favorite' %}">
                    <i class="{% if recipe in user.favorites.all %}error-text{% else %}black-text{% endif %}">
                        {% if recipe in user.favorites.all %}favorite{% else %}favorite_border{% endif %}
                    </i>
                </a>
                {% endif %}
            </div>
            
            <div class="row align-center">
                 {% if recipe.uploaded_by %}
                    <a href="{% url 'index' %}?uploader={{ recipe.uploaded_by.username|urlencode }}" class="row align-center" style="color: inherit; text-decoration: none;">
                        {% if recipe.uploaded_by.avatar %}
                        <img src="{{ recipe.uploaded_by.avatar.url }}" class="circle small" alt="{{ recipe.uploaded_by.username }}">
                        {% else %}
                        <i class="small circle surface">person</i>
                        {% endif %}
                        <div class="ml-2">
                            <span class="small-text">{% trans "Uploaded by" %}</span>
                            <div class="bold">{{ recipe.uploaded_by.get_full_name|default:recipe.uploaded_by.username }}</div>
                        </div>
                    </a>
                {% else %}
                    <i class="small circle surface">person_off</i>
                    <div class="ml-2">
                        <span class="small-text">{% trans "Unknown uploader" %}</span>
                    </div>
                {% endif %}
            </div>
            
            <div class="space"></div>
            <div class="divider"></div>
            <div class="space"></div>

            <h6 class="bold">{% trans "Tags" %}</h6>
            <div class="row wrap">
              {% for tag in recipe.tags.all %}
                <a href="{% url 'index' %}?tag={{ tag.name|urlencode }}" class="chip round surface">{{ tag.name }}</a>
              {% endfor %}
            </div>

            <div class="space"></div>
            <div class="divider"></div>
            <div class="space"></div>
            
            <h6 class="bold">{% trans "Rating" %}</h6>
            <div class="row align-center">
                <i class="primary-text">star</i>
                <span class="h5 ml-1">{{ avg_rating|floatformat:1 }}</span>
                <span class="small-text ml-1">({{ rating_count }} {% trans "vote" %}{% if rating_count != 1 %}s{% endif %})</span>
            </div>
            
             <div class="space"></div>
            
            {% if user.is_authenticated %}
              <article class="border round no-elevate secondary-container">
                  {% if user_rating %}
                    <div class="row align-center">
                        <i class="primary-text">check_circle</i>
                        <span class="ml-2">{% trans "Your rating:" %} <b>{{ user_rating.score }}</b></span>
                    </div>
                  {% else %}
                    <form method="post" action="{% url 'recipe_rate' pk=recipe.pk %}">
                        {% csrf_token %}
                        <label class="bold">{% trans "Rate this sandwich" %}</label>
                        <div class="field middle-align">
                             <label class="slider">
                                <input type="range" 
                                    name="{{ rating_form.score.name }}" 
                                    min="0" 
                                    max="10" 
                                    step="0.1" 
                                    value="{{ rating_form.score.value|default:'5.0' }}"
                                    oninput="document.getElementById('score-output').innerText = parseFloat(this.value).toFixed(1)">
                                <span></span>
                             </label>
                             <span id="score-output" class="bold ml-2">{{ rating_form.score.value|default:"5.0" }}</span>
                        </div>
                        <button type="submit" class="button primary round">{% trans "Submit Rating" %}</button>
                    </form>
                  {% endif %}
              </article>
            {% else %}
               <p><a href="{% url 'admin:login' %}" class="link">{% trans "Log in" %}</a> {% trans "to rate this recipe." %}</p>
            {% endif %}

            {% if user.is_authenticated and user.is_staff %}
            <div class="space"></div>
            <a href="/admin/sandwitches/recipe/{{ recipe.pk }}/change/" class="button transparent border round width-100 center-align">
                <i>edit</i>
                <span>{% trans "Edit Recipe" %}</span>
            </a>
            {% endif %}
        </div>
     </article>
  </div>

  <!-- Right Column: Details -->
  <div class="s12 m12 l7">
      <div class="padding">
          
          <h5 class="primary-text">{% trans "Description" %}</h5>
          <div class="large-text">
            {% if recipe.description %}
                {{ recipe.description|convert_markdown|safe }}
            {% else %}
                <p class="italic">{% trans "No description yet." %}</p>
            {% endif %}
          </div>
          
          <div class="large-space"></div>
          
          <h5 class="primary-text">{% trans "Ingredients" %}</h5>
           <div class="card padding flat gray1">
            {% if recipe.ingredients %}
                {{ recipe.ingredients|convert_markdown|safe }}
            {% else %}
                <p class="italic">{% trans "No ingredients listed." %}</p>
            {% endif %}
           </div>

          <div class="large-space"></div>

          <h5 class="primary-text">{% trans "Instructions" %}</h5>
          <div>
            {% if recipe.instructions %}
                {{ recipe.instructions|convert_markdown|safe }}
            {% else %}
                <p class="italic">{% trans "No instructions yet." %}</p>
            {% endif %}
          </div>
      </div>
  </div>
</div>
{% endblock %}