{% extends "base_pico.html" %}
{% block title %}{{ recipe.title }} â€” Sandwitch{% endblock %}

{% block content %}

{% load markdown_extras %}
<nav aria-label="breadcrumb" class="container">
  <a href="{% url 'index' %}">&larr; Back to all</a>
</nav>

<div class="grid">
  <article class="card">
    <figure>
      {% if recipe.image %}
        <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}">
      {% endif %}
    </figure>
    <header>
      {{ recipe.title }}
    </header>
      <h4>Description</h4>
      {{ recipe.description|convert_markdown|safe|default:"No description yet." }}

      <h4>Ingredients</h4>
      {{ recipe.ingredients|convert_markdown|safe|default:"No ingredients listed." }}

      <h4>Instructions</h4>
      {{ recipe.instructions|convert_markdown|safe|default:"No instructions yet." }}
    
    <div class="tags-row">
      <div style="margin-top:12px;">
        {% for tag in recipe.tags.all %}
          <span class="tag">{{ tag.name }}</span>
        {% endfor %}
      </div>
    </div>

    <div style="margin-top:1rem;">
      <h4>Rating</h4>
      {% if rating_count %}
        <p>Average: {{ avg_rating|floatformat:1 }} ({{ rating_count }} vote{% if rating_count %}s{% endif %})</p>
      {% else %}
        <p>No ratings yet.</p>
      {% endif %}

      {% if user.is_authenticated %}
          {% if user_rating %}
            <p>Your rating: {{ user_rating.score }}</p>
          {% else %}
            <form method="post" action="{% url 'recipe_rate' pk=recipe.pk %}">
                      {% csrf_token %}

                      <fieldset>
                        <legend>What would you rate this sandwich?</legend>

                        {% if rating_form.score.errors %}
                          <div class="card-panel" role="alert">
                            <ul>
                              {% for err in rating_form.score.errors %}
                                <li>{{ err }}</li>
                              {% endfor %}
                            </ul>
                          </div>
                        {% endif %}

                        <div class="row">
                          {% for i in "12345"|make_list %}
                            <div class="col-sm-2">
                              <label class="form-check">
                                <input
                                  type="radio"
                                  name="{{ rating_form.score.name }}"
                                  id="rating-{{ i }}"
                                  value="{{ i }}"
                                  {% if user_rating and user_rating.score|stringformat:"s" == i %}
                                    checked
                                  {% elif rating_form.score.value == i %}
                                    checked
                                  {% endif %}
                                />
                                <span>{{ i }}</span>
                              </label>
                            </div>
                          {% endfor %}
                        </div>
                      </fieldset>
                      <p style="margin-top:0.5rem;">
                        <button type="submit">{% if user_rating %}Update{% else %}Rate{% endif %}</button>
                      </p>
                    </form>
          {% endif %}        
      {% else %}
        <p><a href="{% url 'login' %}">Log in</a> to rate this recipe.</p>
      {% endif %}
    </div>

      {% if user.is_authenticated and user.is_staff %}
    <footer>
        <a href="/admin/sandwitches/recipe/{{ recipe.pk }}/change/">Edit</a>
    </footer>
    {% endif %}
  </article>
</div>
{% endblock %}